<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Memoria Agenda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1220; color:#e5e7eb; }
    header { padding:12px 16px; background:#111827; position:sticky; top:0; display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:18px; }
    main { padding:16px; max-width:840px; margin: 0 auto; }
    section { margin-bottom: 20px; }
    form { display:flex; gap:8px; flex-wrap:wrap; }
    input[type=text] { flex:1; min-width: 240px; padding:10px; border-radius:8px; border:1px solid #374151; background:#0f172a; color:#e5e7eb; }
    button, select { padding:10px 12px; border:0; border-radius:8px; background:#2563eb; color:white; }
    .muted { color:#9ca3af; font-size:12px; }
    ul { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    li { border:1px solid #374151; border-radius:8px; padding:10px 12px; background:#0f172a; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    li.editing { border-color:#2563eb; }
    li.unsaved { border-color:#f59e0b; }
    .row { display:flex; gap:8px; align-items:center; }
    .edit-icon { 
      background:none; border:none; color:#9ca3af; cursor:pointer; padding:4px; border-radius:4px;
      display:inline-flex; align-items:center; justify-content:center; font-size:14px;
    }
    .edit-icon:hover { background:#374151; color:#e5e7eb; }
    .edit-actions { display:flex; gap:4px; }
    .edit-actions button { padding:4px 8px; font-size:12px; }
    .save-btn { background:#059669; }
    .cancel-btn { background:#dc2626; }
    .inline-input { 
      background:#1f2937; border:1px solid #374151; color:#e5e7eb; padding:6px 8px; 
      border-radius:4px; font-size:14px; width:100%; min-width:200px;
    }
    .inline-input:focus { outline:none; border-color:#2563eb; }
    .error-message { color:#ef4444; font-size:12px; margin-top:4px; }
    .tags { color:#9ca3af; font-size:12px; }
    .pill { background:#1f2937; color:#e5e7eb; border-radius:999px; padding:4px 8px; font-size:12px; }
    .sec-title { display:flex; justify-content:space-between; align-items:center; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    .auth-warning { background:#dc2626; color:white; padding:12px 16px; display:none; border-left:4px solid #b91c1c; }
    .auth-warning.show { display:block; }
    .nav-links a { color:#60a5fa; text-decoration:none; padding:8px 12px; border:1px solid #374151; border-radius:6px; font-size:14px; }
    .nav-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header id="header"></header>
  <div id="authWarningContainer"></div>
  <main>
    <div class="grid">
      <section>
        <div class="sec-title">
          <h3>📋 Tasks</h3>
          <span class="muted">Things to do</span>
        </div>
        <form id="taskForm">
          <input id="taskText" type="text" placeholder="Add a task..." required />
          <button type="submit">Add</button>
        </form>
        <ul id="taskList"></ul>
        <button id="refresh" style="margin-top:8px;">Refresh</button>
      </section>
      
      <section>
        <div class="sec-title">
          <h3>🎯 Daily Plan</h3>
          <span class="muted">Quick plan</span>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <select id="energy">
            <option value="low">Low</option>
            <option value="med" selected>Medium</option>
            <option value="high">High</option>
          </select>
          <button id="suggest">Suggest</button>
        </div>
        <ul id="planList"></ul>
      </section>
    </div>
    <p class="muted">Tip: Add this page to your Home Screen for app-like use. Notifications: use ntfy to get alerts on your phone when tasks are due.</p>
  </main>

  <script src="../js/api.js"></script>
  <script src="../js/ui.js"></script>
  <script>
    // Set current page for navigation
    window.memoriaUI.setCurrentPage('agenda');
    
    // Render header and auth warning
    const header = document.getElementById('header');
    const authContainer = document.getElementById('authWarningContainer');
    
    window.memoriaUI.renderHeader(header);
    const authWarning = window.memoriaUI.renderAuthWarning(authContainer);

    // Initialize page elements
    const taskForm = document.getElementById('taskForm');
    const taskText = document.getElementById('taskText');
    const taskList = document.getElementById('taskList');
    const refreshBtn = document.getElementById('refresh');
    const energySel = document.getElementById('energy');
    const suggestBtn = document.getElementById('suggest');
    const planList = document.getElementById('planList');

    async function loadAll() {
      const tasks = await window.memoriaAPI.request('/tasks?open_only=true');
      renderTasks(tasks);
    }

    function renderTasks(tasks) {
      renderList(taskList, tasks, 'task');
    }

    function renderList(el, items, type) {
      el.innerHTML = '';
      for (const it of items) {
        const li = document.createElement('li');
        li.dataset.id = it.id;
        li.dataset.type = type;
        
        const left = document.createElement('div'); 
        left.className = 'row';
        left.style.flex = '1';
        
        const contentContainer = document.createElement('div');
        contentContainer.style.flex = '1';
        
        const title = document.createElement('div'); 
        title.textContent = it.title;
        title.className = 'content-text';
        
        const meta = document.createElement('div'); 
        meta.className = 'tags'; 
        meta.textContent = (it.due ? new Date(it.due).toLocaleString() : '') + (it.tags?' '+it.tags:'');
        
        contentContainer.append(title, meta);
        
        const editIcon = document.createElement('button');
        editIcon.className = 'edit-icon';
        editIcon.innerHTML = '✏️';
        editIcon.title = 'Edit';
        editIcon.onclick = () => startEdit(li, 'task', it);
        
        left.append(contentContainer, editIcon);
        
        const right = document.createElement('div'); 
        right.className = 'row';
        const doneBtn = document.createElement('button'); 
        doneBtn.className = 'pill'; 
        doneBtn.textContent = 'Done';
        doneBtn.onclick = async () => { 
          await window.memoriaAPI.request(`/tasks/${it.id}/done?done=true`, 'POST'); 
          await loadAll(); 
          suggestBtn.click(); 
        };
        const deleteBtn = document.createElement('button'); 
        deleteBtn.className = 'pill'; 
        deleteBtn.textContent = '🗑️';
        deleteBtn.onclick = async () => { 
          if (confirm('Delete this task?')) {
            await window.memoriaAPI.request(`/tasks/${it.id}`, 'DELETE');
            await loadAll();
          }
        };
        right.append(doneBtn, deleteBtn);
        
        li.append(left, right);
        el.append(li);
      }
    }

    function startEdit(li, type, item) {
      // Simple edit implementation
      const newText = prompt('Edit:', item.title);
      if (newText && newText !== item.title) {
        saveEdit(li, type, item.id, newText);
      }
    }

    async function saveEdit(li, type, id, newValue) {
      try {
        if (type === 'task') {
          await window.memoriaAPI.request(`/tasks/${id}`, 'PUT', { title: newValue });
        }
        await loadAll();
      } catch (error) {
        console.error('Failed to save edit:', error);
      }
    }

    // Event handlers
    taskForm.onsubmit = async (e) => {
      e.preventDefault();
      const title = taskText.value.trim();
      if (!title) return;
      
      try {
        await window.memoriaAPI.request('/tasks', 'POST', { title });
        taskText.value = '';
        await loadAll();
      } catch (error) {
        console.error('Failed to add task:', error);
      }
    };

    refreshBtn.onclick = loadAll;

    suggestBtn.onclick = async () => {
      const tasks = await window.memoriaAPI.request('/tasks?open_only=true');
      const energy = energySel.value;
      const scored = tasks.map(t => {
        let score = 0;
        if ((t.tags||'').includes('#ydt')) score += 3;
        if (t.due) {
          const d = new Date(t.due);
          const hours = (d - new Date())/36e5;
          if (hours < 0) score += 3;
          else if (hours < 24) score += 2;
          else if (hours < 72) score += 1;
        }
        
        if (energy === 'low') {
          if ((t.tags||'').includes('#easy')) score += 2;
          if ((t.tags||'').includes('#quick')) score += 1;
        } else if (energy === 'high') {
          if ((t.tags||'').includes('#hard')) score += 2;
          if ((t.tags||'').includes('#focus')) score += 1;
        }
        
        return { ...t, score };
      }).sort((a, b) => b.score - a.score);
      
      planList.innerHTML = '';
      const topTasks = scored.slice(0, 5);
      for (const t of topTasks) {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <div>${t.title}</div>
            <div class="tags">Score: ${t.score} ${t.tags||''}</div>
          </div>
        `;
        planList.append(li);
      }
    };

    // Load initial data
    loadAll();
  </script>
</body>
</html>