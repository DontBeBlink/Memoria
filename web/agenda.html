<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Memoria Agenda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1220; color:#e5e7eb; }
    header { padding:12px 16px; background:#111827; position:sticky; top:0; display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:18px; }
    main { padding:16px; max-width:840px; margin: 0 auto; }
    section { margin-bottom: 20px; }
    form { display:flex; gap:8px; flex-wrap:wrap; }
    input[type=text] { flex:1; min-width: 240px; padding:10px; border-radius:8px; border:1px solid #374151; background:#0f172a; color:#e5e7eb; }
    button, select { padding:10px 12px; border:0; border-radius:8px; background:#2563eb; color:white; }
    .muted { color:#9ca3af; font-size:12px; }
    ul { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    li { border:1px solid #374151; border-radius:8px; padding:10px 12px; background:#0f172a; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    li.editing { border-color:#2563eb; }
    li.unsaved { border-color:#f59e0b; }
    .row { display:flex; gap:8px; align-items:center; }
    .edit-icon { 
      background:none; border:none; color:#9ca3af; cursor:pointer; padding:4px; border-radius:4px;
      display:inline-flex; align-items:center; justify-content:center; font-size:14px;
    }
    .edit-icon:hover { background:#374151; color:#e5e7eb; }
    .edit-actions { display:flex; gap:4px; }
    .edit-actions button { padding:4px 8px; font-size:12px; }
    .save-btn { background:#059669; }
    .cancel-btn { background:#dc2626; }
    .inline-input { 
      background:#1f2937; border:1px solid #374151; color:#e5e7eb; padding:6px 8px; 
      border-radius:4px; font-size:14px; width:100%; min-width:200px;
    }
    .inline-input:focus { outline:none; border-color:#2563eb; }
    .error-message { color:#ef4444; font-size:12px; margin-top:4px; }
    .tags { color:#9ca3af; font-size:12px; }
    .pill { background:#1f2937; color:#e5e7eb; border-radius:999px; padding:4px 8px; font-size:12px; }
    .sec-title { display:flex; justify-content:space-between; align-items:center; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    
    /* Agenda-specific styles */
    .agenda-tabs { display:flex; gap:8px; margin-bottom:16px; }
    .agenda-tab { 
      padding:8px 16px; border:1px solid #374151; border-radius:6px; background:#0f172a; 
      color:#9ca3af; cursor:pointer; transition:all 0.2s;
    }
    .agenda-tab.active { background:#2563eb; color:white; border-color:#2563eb; }
    .agenda-tab:hover:not(.active) { background:#374151; color:#e5e7eb; }
    
    .agenda-view { display:none; }
    .agenda-view.active { display:block; }
    
    .time-group { margin-bottom:16px; }
    .time-group h4 { 
      margin:0 0 8px 0; color:#60a5fa; font-size:14px; font-weight:500;
      padding:4px 8px; background:#1f2937; border-radius:4px; display:inline-block;
    }
    
    .quick-actions { display:flex; gap:4px; margin-left:8px; }
    .quick-action { 
      padding:2px 6px; font-size:11px; border-radius:4px; 
      background:#374151; color:#e5e7eb; border:none; cursor:pointer;
    }
    .quick-action:hover { background:#4b5563; }
    .quick-action.done { background:#059669; }
    .quick-action.reschedule { background:#f59e0b; }
    
    .agenda-container { max-width:1000px; margin:0 auto; }
    .auth-warning { background:#dc2626; color:white; padding:12px 16px; display:none; border-left:4px solid #b91c1c; }
    .auth-warning.show { display:block; }
    .nav-links a { color:#60a5fa; text-decoration:none; padding:8px 12px; border:1px solid #374151; border-radius:6px; font-size:14px; }
    .nav-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header id="header"></header>
  <div id="authWarningContainer"></div>
  <main>
    <div class="agenda-container">
      <!-- Add Task Form -->
      <section style="margin-bottom:20px;">
        <form id="taskForm">
          <input id="taskText" type="text" placeholder="Add a task... (try 'Meeting Mon 9a' or 'Call client in 2h')" required />
          <button type="submit">Add</button>
        </form>
      </section>

      <!-- View Tabs -->
      <div class="agenda-tabs">
        <div class="agenda-tab active" data-view="day">ðŸ“… Day</div>
        <div class="agenda-tab" data-view="week">ðŸ“† Week</div>
      </div>

      <!-- Day View -->
      <div id="dayView" class="agenda-view active">
        <div class="sec-title" style="margin-bottom:16px;">
          <h3 id="dayTitle">Today</h3>
          <div class="row">
            <button id="prevDay">&lt;</button>
            <button id="nextDay">&gt;</button>
            <button id="todayBtn">Today</button>
          </div>
        </div>
        <div id="dayContent"></div>
      </div>

      <!-- Week View -->
      <div id="weekView" class="agenda-view">
        <div class="sec-title" style="margin-bottom:16px;">
          <h3 id="weekTitle">This Week</h3>
          <div class="row">
            <button id="prevWeek">&lt;</button>
            <button id="nextWeek">&gt;</button>
            <button id="thisWeekBtn">This Week</button>
          </div>
        </div>
        <div id="weekContent"></div>
      </div>

      <!-- Quick Plan Section (preserved) -->
      <section style="margin-top:32px; padding-top:16px; border-top:1px solid #374151;">
        <div class="sec-title">
          <h3>ðŸŽ¯ Quick Plan</h3>
          <span class="muted">AI suggestions based on energy</span>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <select id="energy">
            <option value="low">Low</option>
            <option value="med" selected>Medium</option>
            <option value="high">High</option>
          </select>
          <button id="suggest">Suggest</button>
        </div>
        <ul id="planList"></ul>
      </section>
    </div>
    <p class="muted">Tip: Add this page to your Home Screen for app-like use. Notifications: use ntfy to get alerts on your phone when tasks are due.</p>
  </main>

  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
  <script>
    // Set current page for navigation
    window.memoriaUI.setCurrentPage('agenda');
    
    // Render header and auth warning
    const header = document.getElementById('header');
    const authContainer = document.getElementById('authWarningContainer');
    
    window.memoriaUI.renderHeader(header);
    const authWarning = window.memoriaUI.renderAuthWarning(authContainer);

    // Initialize page elements
    const taskForm = document.getElementById('taskForm');
    const taskText = document.getElementById('taskText');
    const energySel = document.getElementById('energy');
    const suggestBtn = document.getElementById('suggest');
    const planList = document.getElementById('planList');

    // Tab elements
    const tabs = document.querySelectorAll('.agenda-tab');
    const dayView = document.getElementById('dayView');
    const weekView = document.getElementById('weekView');
    
    // Navigation elements
    const dayTitle = document.getElementById('dayTitle');
    const weekTitle = document.getElementById('weekTitle');
    const dayContent = document.getElementById('dayContent');
    const weekContent = document.getElementById('weekContent');
    
    // Day navigation
    const prevDayBtn = document.getElementById('prevDay');
    const nextDayBtn = document.getElementById('nextDay');
    const todayBtn = document.getElementById('todayBtn');
    
    // Week navigation
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    const thisWeekBtn = document.getElementById('thisWeekBtn');

    // Current view state
    let currentView = 'day';
    let currentDate = new Date();
    
    // Utility functions
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    function formatDateTime(date) {
      return date.toISOString();
    }
    
    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }
    
    function addHours(date, hours) {
      const result = new Date(date);
      result.setTime(result.getTime() + (hours * 60 * 60 * 1000));
      return result;
    }
    
    function getWeekStart(date) {
      const result = new Date(date);
      const day = result.getDay();
      const diff = result.getDate() - day;
      return new Date(result.setDate(diff));
    }
    
    function getWeekEnd(date) {
      const weekStart = getWeekStart(date);
      return addDays(weekStart, 6);
    }

    // Task management functions
    async function loadTasks(start, end) {
      const params = new URLSearchParams({ open_only: 'true' });
      if (start) params.append('start', start);
      if (end) params.append('end', end);
      
      try {
        return await window.memoriaAPI.request(`/tasks?${params}`);
      } catch (error) {
        console.error('Failed to load tasks:', error);
        return [];
      }
    }

    async function rescheduleTask(taskId, newDue) {
      try {
        await window.memoriaAPI.request(`/tasks/${taskId}`, 'PATCH', { due: newDue });
        await refreshCurrentView();
      } catch (error) {
        console.error('Failed to reschedule task:', error);
      }
    }

    async function markTaskDone(taskId) {
      try {
        await window.memoriaAPI.request(`/tasks/${taskId}`, 'PATCH', { done: true });
        await refreshCurrentView();
      } catch (error) {
        console.error('Failed to mark task done:', error);
      }
    }

    // Quick action handlers
    function createQuickActions(task) {
      const actions = document.createElement('div');
      actions.className = 'quick-actions';
      
      const doneBtn = document.createElement('button');
      doneBtn.className = 'quick-action done';
      doneBtn.textContent = 'Done';
      doneBtn.onclick = () => markTaskDone(task.id);
      
      const oneHourBtn = document.createElement('button');
      oneHourBtn.className = 'quick-action reschedule';
      oneHourBtn.textContent = '+1h';
      oneHourBtn.onclick = () => {
        const newDue = task.due ? addHours(new Date(task.due), 1) : addHours(new Date(), 1);
        rescheduleTask(task.id, formatDateTime(newDue));
      };
      
      const oneDayBtn = document.createElement('button');
      oneDayBtn.className = 'quick-action reschedule';
      oneDayBtn.textContent = '+1d';
      oneDayBtn.onclick = () => {
        const newDue = task.due ? addDays(new Date(task.due), 1) : addDays(new Date(), 1);
        rescheduleTask(task.id, formatDateTime(newDue));
      };
      
      const nextWeekBtn = document.createElement('button');
      nextWeekBtn.className = 'quick-action reschedule';
      nextWeekBtn.textContent = 'Next week';
      nextWeekBtn.onclick = () => {
        const newDue = task.due ? addDays(new Date(task.due), 7) : addDays(new Date(), 7);
        rescheduleTask(task.id, formatDateTime(newDue));
      };
      
      const pickDateBtn = document.createElement('button');
      pickDateBtn.className = 'quick-action reschedule';
      pickDateBtn.textContent = 'Pick date';
      pickDateBtn.onclick = () => {
        const currentDue = task.due ? new Date(task.due).toISOString().slice(0, 16) : '';
        const newDateTime = prompt('Enter new date and time (YYYY-MM-DDTHH:MM):', currentDue);
        if (newDateTime) {
          try {
            const newDue = new Date(newDateTime);
            rescheduleTask(task.id, formatDateTime(newDue));
          } catch (error) {
            alert('Invalid date format');
          }
        }
      };
      
      actions.append(doneBtn, oneHourBtn, oneDayBtn, nextWeekBtn, pickDateBtn);
      return actions;
    }

    // Render task item
    function renderTask(task) {
      const li = document.createElement('li');
      
      const left = document.createElement('div');
      left.style.flex = '1';
      
      const title = document.createElement('div');
      title.textContent = task.title;
      title.className = 'content-text';
      
      const meta = document.createElement('div');
      meta.className = 'tags';
      const dueText = task.due ? new Date(task.due).toLocaleString() : 'No due date';
      meta.textContent = dueText + (task.tags ? ' ' + task.tags : '');
      
      left.append(title, meta);
      
      const right = createQuickActions(task);
      
      li.append(left, right);
      return li;
    }

    // Day view functions
    async function renderDayView() {
      const start = formatDate(currentDate) + 'T00:00:00';
      const end = formatDate(currentDate) + 'T23:59:59';
      const tasks = await loadTasks(start, end);
      
      dayTitle.textContent = currentDate.toDateString();
      dayContent.innerHTML = '';
      
      // Group tasks by hour
      const hourGroups = {};
      const noTimeGroup = [];
      
      for (const task of tasks) {
        if (task.due) {
          const hour = new Date(task.due).getHours();
          const hourKey = `${hour.toString().padStart(2, '0')}:00`;
          if (!hourGroups[hourKey]) hourGroups[hourKey] = [];
          hourGroups[hourKey].push(task);
        } else {
          noTimeGroup.push(task);
        }
      }
      
      // Render time groups
      const sortedHours = Object.keys(hourGroups).sort();
      for (const hour of sortedHours) {
        const timeGroup = document.createElement('div');
        timeGroup.className = 'time-group';
        
        const timeHeader = document.createElement('h4');
        timeHeader.textContent = hour;
        timeGroup.append(timeHeader);
        
        const taskList = document.createElement('ul');
        for (const task of hourGroups[hour]) {
          taskList.append(renderTask(task));
        }
        timeGroup.append(taskList);
        dayContent.append(timeGroup);
      }
      
      // Render tasks without specific time
      if (noTimeGroup.length > 0) {
        const timeGroup = document.createElement('div');
        timeGroup.className = 'time-group';
        
        const timeHeader = document.createElement('h4');
        timeHeader.textContent = 'No specific time';
        timeGroup.append(timeHeader);
        
        const taskList = document.createElement('ul');
        for (const task of noTimeGroup) {
          taskList.append(renderTask(task));
        }
        timeGroup.append(taskList);
        dayContent.append(timeGroup);
      }
      
      if (tasks.length === 0) {
        dayContent.innerHTML = '<p class="muted">No tasks for this day</p>';
      }
    }

    // Week view functions
    async function renderWeekView() {
      const weekStart = getWeekStart(currentDate);
      const weekEnd = getWeekEnd(currentDate);
      
      const start = formatDate(weekStart) + 'T00:00:00';
      const end = formatDate(weekEnd) + 'T23:59:59';
      const tasks = await loadTasks(start, end);
      
      const weekStartStr = weekStart.toLocaleDateString();
      const weekEndStr = weekEnd.toLocaleDateString();
      weekTitle.textContent = `${weekStartStr} - ${weekEndStr}`;
      
      weekContent.innerHTML = '';
      
      // Group tasks by day
      const dayGroups = {};
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      
      for (let i = 0; i < 7; i++) {
        const day = addDays(weekStart, i);
        const dayKey = formatDate(day);
        const dayName = dayNames[day.getDay()];
        const displayName = `${dayName} ${day.getDate()}`;
        dayGroups[displayName] = { date: dayKey, tasks: [] };
      }
      
      for (const task of tasks) {
        if (task.due) {
          const taskDate = formatDate(new Date(task.due));
          const dayEntry = Object.entries(dayGroups).find(([_, data]) => data.date === taskDate);
          if (dayEntry) {
            dayEntry[1].tasks.push(task);
          }
        }
      }
      
      // Render day groups
      for (const [dayName, data] of Object.entries(dayGroups)) {
        if (data.tasks.length > 0) {
          const timeGroup = document.createElement('div');
          timeGroup.className = 'time-group';
          
          const timeHeader = document.createElement('h4');
          timeHeader.textContent = dayName;
          timeGroup.append(timeHeader);
          
          const taskList = document.createElement('ul');
          for (const task of data.tasks) {
            taskList.append(renderTask(task));
          }
          timeGroup.append(taskList);
          weekContent.append(timeGroup);
        }
      }
      
      if (tasks.length === 0) {
        weekContent.innerHTML = '<p class="muted">No tasks for this week</p>';
      }
    }

    // View management
    function switchView(view) {
      currentView = view;
      
      // Update tab states
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
      });
      
      // Update view visibility
      dayView.classList.toggle('active', view === 'day');
      weekView.classList.toggle('active', view === 'week');
      
      refreshCurrentView();
    }

    async function refreshCurrentView() {
      if (currentView === 'day') {
        await renderDayView();
      } else {
        await renderWeekView();
      }
    }

    // Event handlers
    tabs.forEach(tab => {
      tab.onclick = () => switchView(tab.dataset.view);
    });

    prevDayBtn.onclick = () => {
      currentDate = addDays(currentDate, -1);
      renderDayView();
    };

    nextDayBtn.onclick = () => {
      currentDate = addDays(currentDate, 1);
      renderDayView();
    };

    todayBtn.onclick = () => {
      currentDate = new Date();
      renderDayView();
    };

    prevWeekBtn.onclick = () => {
      currentDate = addDays(currentDate, -7);
      renderWeekView();
    };

    nextWeekBtn.onclick = () => {
      currentDate = addDays(currentDate, 7);
      renderWeekView();
    };

    thisWeekBtn.onclick = () => {
      currentDate = new Date();
      renderWeekView();
    };

    taskForm.onsubmit = async (e) => {
      e.preventDefault();
      const title = taskText.value.trim();
      if (!title) return;
      
      try {
        await window.memoriaAPI.request('/tasks', 'POST', { title });
        taskText.value = '';
        await refreshCurrentView();
      } catch (error) {
        console.error('Failed to add task:', error);
      }
    };

    // Quick plan functionality (preserved)
    suggestBtn.onclick = async () => {
      const tasks = await window.memoriaAPI.request('/tasks?open_only=true');
      const energy = energySel.value;
      const scored = tasks.map(t => {
        let score = 0;
        if ((t.tags||'').includes('#ydt')) score += 3;
        if (t.due) {
          const d = new Date(t.due);
          const hours = (d - new Date())/36e5;
          if (hours < 0) score += 3;
          else if (hours < 24) score += 2;
          else if (hours < 72) score += 1;
        }
        
        if (energy === 'low') {
          if ((t.tags||'').includes('#easy')) score += 2;
          if ((t.tags||'').includes('#quick')) score += 1;
        } else if (energy === 'high') {
          if ((t.tags||'').includes('#hard')) score += 2;
          if ((t.tags||'').includes('#focus')) score += 1;
        }
        
        return { ...t, score };
      }).sort((a, b) => b.score - a.score);
      
      planList.innerHTML = '';
      const topTasks = scored.slice(0, 5);
      for (const t of topTasks) {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <div>${t.title}</div>
            <div class="tags">Score: ${t.score} ${t.tags||''}</div>
          </div>
        `;
        planList.append(li);
      }
    };

    // Initialize
    renderDayView();
  </script>
</body>
</html>