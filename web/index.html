<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Memoria Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1220; color:#e5e7eb; }
    header { padding:12px 16px; background:#111827; position:sticky; top:0; display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:18px; }
    main { padding:16px; max-width:840px; margin: 0 auto; }
    section { margin-bottom: 20px; }
    form { display:flex; gap:8px; flex-wrap:wrap; }
    input[type=text] { flex:1; min-width: 240px; padding:10px; border-radius:8px; border:1px solid #374151; background:#0f172a; color:#e5e7eb; }
    button, select { padding:10px 12px; border:0; border-radius:8px; background:#2563eb; color:white; }
    .muted { color:#9ca3af; font-size:12px; }
    ul { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    li { border:1px solid #374151; border-radius:8px; padding:10px 12px; background:#0f172a; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    li.editing { border-color:#2563eb; }
    li.unsaved { border-color:#f59e0b; }
    .row { display:flex; gap:8px; align-items:center; }
    .edit-icon { 
      background:none; border:none; color:#9ca3af; cursor:pointer; padding:4px; border-radius:4px;
      display:inline-flex; align-items:center; justify-content:center; font-size:14px;
    }
    .edit-icon:hover { background:#374151; color:#e5e7eb; }
    .edit-actions { display:flex; gap:4px; }
    .edit-actions button { padding:4px 8px; font-size:12px; }
    .save-btn { background:#059669; }
    .cancel-btn { background:#dc2626; }
    .inline-input { 
      background:#1f2937; border:1px solid #374151; color:#e5e7eb; padding:6px 8px; 
      border-radius:4px; font-size:14px; width:100%; min-width:200px;
    }
    .inline-input:focus { outline:none; border-color:#2563eb; }
    .error-message { color:#ef4444; font-size:12px; margin-top:4px; }
    .tags { color:#9ca3af; font-size:12px; }
    .pill { background:#1f2937; color:#e5e7eb; border-radius:999px; padding:4px 8px; font-size:12px; }
    .sec-title { display:flex; justify-content:space-between; align-items:center; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    .auth-warning { background:#dc2626; color:white; padding:12px 16px; display:none; border-left:4px solid #b91c1c; }
    .auth-warning.show { display:block; }
    .mic-button { background:#dc2626; color:white; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; border:0; transition:all 0.2s; }
    .mic-button:hover { background:#b91c1c; transform:scale(1.05); }
    .mic-button.recording { background:#ef4444; animation:pulse 1s infinite; }
    .mic-button:disabled { background:#6b7280; cursor:not-allowed; }
    @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.7; } }
    .status-message { background:#1f2937; color:#e5e7eb; padding:8px 12px; border-radius:6px; font-size:12px; display:none; margin-left:8px; }
    .error-banner { background:#dc2626; color:white; padding:8px 16px; display:none; border-radius:6px; margin:8px 0; font-size:14px; }
    .error-banner.show { display:block; }
    .nav-links a { color:#60a5fa; text-decoration:none; padding:8px 12px; border:1px solid #374151; border-radius:6px; font-size:14px; }
    .nav-links a:hover { text-decoration:underline; }
    .overview-card { border:1px solid #374151; border-radius:8px; padding:16px; background:#0f172a; margin-bottom:16px; }
    .overview-stats { display:flex; gap:16px; justify-content:space-around; text-align:center; }
    .stat-item { flex:1; }
    .stat-number { font-size:24px; font-weight:bold; color:#60a5fa; }
    .stat-label { font-size:12px; color:#9ca3af; }
  </style>
</head>
<body>
  <header id="header"></header>
  <div id="authWarningContainer"></div>
  <div id="errorBanner" class="error-banner">
    <strong>Error:</strong> <span id="errorMessage"></span>
  </div>
  <main>
    <section>
      <div class="overview-card">
        <h3>üè† Welcome to Memoria Hub</h3>
        <p class="muted">Your personal memory and task management system</p>
        
        <div class="overview-stats">
          <div class="stat-item">
            <div class="stat-number" id="memoryCount">-</div>
            <div class="stat-label">Memories</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="taskCount">-</div>
            <div class="stat-label">Open Tasks</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="dueCount">-</div>
            <div class="stat-label">Due Today</div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="sec-title">
        <h3>üöÄ Quick Actions</h3>
        <span class="muted">Get started</span>
      </div>
      <div class="grid">
        <div class="overview-card">
          <h4>üìù Add Memory</h4>
          <form id="quickMemForm">
            <input id="quickMemText" type="text" placeholder="What happened today? (@name, #tags)" />
            <button type="submit">Save</button>
          </form>
          <p class="muted">Quickly capture a memory or go to <a href="web/memories.html">Memories</a> for full features</p>
        </div>
        
        <div class="overview-card">
          <h4>‚úÖ Add Task</h4>
          <form id="quickTaskForm">
            <input id="quickTaskText" type="text" placeholder="What needs to be done? (Monday 9am, #tags)" />
            <button type="submit">Save</button>
          </form>
          <p class="muted">Quickly add a task or go to <a href="web/agenda.html">Agenda</a> for planning</p>
        </div>
      </div>
    </section>

    <section>
      <div class="sec-title">
        <h3>üìã Recent Activity</h3>
        <span class="muted">Latest items</span>
      </div>
      <div class="grid">
        <div>
          <h4>Recent Memories</h4>
          <ul id="recentMemories"></ul>
          <p class="muted"><a href="web/memories.html">View all memories ‚Üí</a></p>
        </div>
        
        <div>
          <h4>Upcoming Tasks</h4>
          <ul id="upcomingTasks"></ul>
          <p class="muted"><a href="web/agenda.html">View full agenda ‚Üí</a></p>
        </div>
      </div>
    </section>
    
    <p class="muted">Tip: Add this page to your Home Screen for app-like use. Navigate using the menu above to access different sections.</p>
  </main>

  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/dictation.js"></script>
  <script>
    // Set current page for navigation
    window.memoriaUI.setCurrentPage('hub');
    
    // Render header and auth warning
    const header = document.getElementById('header');
    const authContainer = document.getElementById('authWarningContainer');
    
    window.memoriaUI.renderHeader(header, {
      showMicButton: true,
      showInstallButton: true,
      onMicButtonClick: initializeDictation,
      onInstallClick: handleInstall
    });
    
    const authWarning = window.memoriaUI.renderAuthWarning(authContainer);

    // Dashboard elements
    const memoryCount = document.getElementById('memoryCount');
    const taskCount = document.getElementById('taskCount');
    const dueCount = document.getElementById('dueCount');
    const quickMemForm = document.getElementById('quickMemForm');
    const quickMemText = document.getElementById('quickMemText');
    const quickTaskForm = document.getElementById('quickTaskForm');
    const quickTaskText = document.getElementById('quickTaskText');
    const recentMemories = document.getElementById('recentMemories');
    const upcomingTasks = document.getElementById('upcomingTasks');

    // Voice dictation initialization
    function initializeDictation() {
      const voiceDict = new VoiceDictation();
      voiceDict.init('micButton', 'micStatus', 
        (transcription) => {
          quickMemText.value = transcription;
          quickMemForm.dispatchEvent(new Event('submit'));
        },
        (error) => console.error('Dictation error:', error)
      );
    }

    // PWA install handling
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installBtn = document.getElementById('install');
      if (installBtn) installBtn.style.display = 'block';
    });

    function handleInstall() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          deferredPrompt = null;
          const installBtn = document.getElementById('install');
          if (installBtn) installBtn.style.display = 'none';
        });
      }
    }

    // Dashboard functions
    async function loadDashboardStats() {
      try {
        // Load memory count (latest 1 with total count)
        const memParams = new URLSearchParams({ limit: 1, offset: 0 });
        const memories = await window.memoriaAPI.request(`/memories?${memParams}`);
        
        // For now, estimate based on recent memories - in a real app, you'd want a count endpoint
        memoryCount.textContent = memories.length > 0 ? '10+' : '0';
        
        // Load open tasks
        const tasks = await window.memoriaAPI.request('/tasks?open_only=true');
        taskCount.textContent = tasks.length;
        
        // Count due today
        const today = new Date();
        today.setHours(23, 59, 59, 999);
        const todayDue = tasks.filter(t => t.due && new Date(t.due) <= today).length;
        dueCount.textContent = todayDue;
        
        return { memories, tasks };
      } catch (error) {
        console.error('Failed to load dashboard stats:', error);
        memoryCount.textContent = '?';
        taskCount.textContent = '?';
        dueCount.textContent = '?';
        return { memories: [], tasks: [] };
      }
    }

    async function loadRecentActivity() {
      try {
        // Load recent memories
        const memParams = new URLSearchParams({ limit: 3, offset: 0 });
        const memories = await window.memoriaAPI.request(`/memories?${memParams}`);
        
        recentMemories.innerHTML = '';
        if (memories.length === 0) {
          recentMemories.innerHTML = '<li style="border:none; padding:8px; background:transparent;">No memories yet</li>';
        } else {
          memories.forEach(memory => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div style="flex:1;">
                <div>${memory.text}</div>
                <div class="tags">${memory.tags || ''}</div>
              </div>
            `;
            recentMemories.appendChild(li);
          });
        }
        
        // Load upcoming tasks
        const tasks = await window.memoriaAPI.request('/tasks?open_only=true');
        const sortedTasks = tasks
          .filter(t => t.due)
          .sort((a, b) => new Date(a.due) - new Date(b.due))
          .slice(0, 3);
        
        upcomingTasks.innerHTML = '';
        if (sortedTasks.length === 0) {
          upcomingTasks.innerHTML = '<li style="border:none; padding:8px; background:transparent;">No upcoming tasks</li>';
        } else {
          sortedTasks.forEach(task => {
            const li = document.createElement('li');
            const dueDate = new Date(task.due);
            li.innerHTML = `
              <div style="flex:1;">
                <div>${task.title}</div>
                <div class="tags">${dueDate.toLocaleDateString()} ${task.tags || ''}</div>
              </div>
            `;
            upcomingTasks.appendChild(li);
          });
        }
      } catch (error) {
        console.error('Failed to load recent activity:', error);
      }
    }

    // Form handlers
    quickMemForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = quickMemText.value.trim();
      if (!text) return;
      
      try {
        await window.memoriaAPI.request('/memories', 'POST', { text });
        quickMemText.value = '';
        loadDashboardStats();
        loadRecentActivity();
      } catch (error) {
        console.error('Failed to add memory:', error);
        alert('Failed to add memory: ' + error.message);
      }
    };

    quickTaskForm.onsubmit = async (e) => {
      e.preventDefault();
      const title = quickTaskText.value.trim();
      if (!title) return;
      
      try {
        await window.memoriaAPI.request('/tasks', 'POST', { title });
        quickTaskText.value = '';
        loadDashboardStats();
        loadRecentActivity();
      } catch (error) {
        console.error('Failed to add task:', error);
        alert('Failed to add task: ' + error.message);
      }
    };

    // Initialize dashboard
    async function initDashboard() {
      await loadDashboardStats();
      await loadRecentActivity();
    }

    // Register service worker
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');

    // Load dashboard data
    initDashboard();

    // Initialize dictation after page load
    document.addEventListener('DOMContentLoaded', initializeDictation);
  </script>
</body>
</html>
