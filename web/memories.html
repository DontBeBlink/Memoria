<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Memoria Memories</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="../manifest.json" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1220; color:#e5e7eb; }
    header { padding:12px 16px; background:#111827; position:sticky; top:0; display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:18px; }
    main { padding:16px; max-width:840px; margin: 0 auto; }
    section { margin-bottom: 20px; }
    form { display:flex; gap:8px; flex-wrap:wrap; }
    input[type=text] { flex:1; min-width: 240px; padding:10px; border-radius:8px; border:1px solid #374151; background:#0f172a; color:#e5e7eb; }
    button, select { padding:10px 12px; border:0; border-radius:8px; background:#2563eb; color:white; }
    .muted { color:#9ca3af; font-size:12px; }
    ul { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    li { border:1px solid #374151; border-radius:8px; padding:10px 12px; background:#0f172a; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    li.editing { border-color:#2563eb; }
    li.unsaved { border-color:#f59e0b; }
    .row { display:flex; gap:8px; align-items:center; }
    .edit-icon { 
      background:none; border:none; color:#9ca3af; cursor:pointer; padding:4px; border-radius:4px;
      display:inline-flex; align-items:center; justify-content:center; font-size:14px;
    }
    .edit-icon:hover { background:#374151; color:#e5e7eb; }
    .edit-actions { display:flex; gap:4px; }
    .edit-actions button { padding:4px 8px; font-size:12px; }
    .save-btn { background:#059669; }
    .cancel-btn { background:#dc2626; }
    .inline-input { 
      background:#1f2937; border:1px solid #374151; color:#e5e7eb; padding:6px 8px; 
      border-radius:4px; font-size:14px; width:100%; min-width:200px;
    }
    .inline-input:focus { outline:none; border-color:#2563eb; }
    .error-message { color:#ef4444; font-size:12px; margin-top:4px; }
    .tags { color:#9ca3af; font-size:12px; }
    .pill { background:#1f2937; color:#e5e7eb; border-radius:999px; padding:4px 8px; font-size:12px; }
    .sec-title { display:flex; justify-content:space-between; align-items:center; }
    .auth-warning { background:#dc2626; color:white; padding:12px 16px; display:none; border-left:4px solid #b91c1c; }
    .auth-warning.show { display:block; }
    .mic-button { background:#dc2626; color:white; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; border:0; transition:all 0.2s; }
    .mic-button:hover { background:#b91c1c; transform:scale(1.05); }
    .mic-button.recording { background:#ef4444; animation:pulse 1s infinite; }
    .mic-button:disabled { background:#6b7280; cursor:not-allowed; }
    @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.7; } }
    .status-message { background:#1f2937; color:#e5e7eb; padding:8px 12px; border-radius:6px; font-size:12px; display:none; margin-left:8px; }
    .nav-links a { color:#60a5fa; text-decoration:none; padding:8px 12px; border:1px solid #374151; border-radius:6px; font-size:14px; }
    .nav-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header id="header"></header>
  <div id="authWarningContainer"></div>
  <main>
    <section>
      <div class="sec-title">
        <h3>üìù Memories</h3>
        <span class="muted">All your saved memories</span>
      </div>
      <form id="memForm">
        <input id="memText" type="text" placeholder="What happened today?" required />
        <button type="submit">Add</button>
      </form>
      <div class="row" style="margin:8px 0;">
        <input id="memSearch" type="text" placeholder="Search memories..." style="flex:1;" />
        <button id="memSearchBtn">Search</button>
        <button id="memClearBtn">Clear</button>
      </div>
      <div id="memPagination" class="row" style="justify-content:space-between; margin:8px 0;">
        <button id="memPrevBtn">‚Üê Previous</button>
        <span id="memPageInfo" class="muted">Page 1</span>
        <button id="memNextBtn">Next ‚Üí</button>
      </div>
      <ul id="memList"></ul>
    </section>
  </main>

  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/dictation.js"></script>
  <script>
    // Set current page for navigation
    window.memoriaUI.setCurrentPage('memories');
    
    // Render header and auth warning
    const header = document.getElementById('header');
    const authContainer = document.getElementById('authWarningContainer');
    
    window.memoriaUI.renderHeader(header, {
      showMicButton: true,
      onMicButtonClick: initializeDictation
    });
    
    const authWarning = window.memoriaUI.renderAuthWarning(authContainer);

    // Initialize page elements
    const memForm = document.getElementById('memForm');
    const memText = document.getElementById('memText');
    const memList = document.getElementById('memList');
    const memSearch = document.getElementById('memSearch');
    const memSearchBtn = document.getElementById('memSearchBtn');
    const memClearBtn = document.getElementById('memClearBtn');
    const memPagination = document.getElementById('memPagination');
    const memPrevBtn = document.getElementById('memPrevBtn');
    const memNextBtn = document.getElementById('memNextBtn');
    const memPageInfo = document.getElementById('memPageInfo');

    // Pagination state
    let memCurrentPage = 0;
    let memCurrentQuery = '';
    const memPerPage = 50;

    // Voice dictation initialization
    function initializeDictation() {
      const voiceDict = new VoiceDictation();
      voiceDict.init('micButton', 'micStatus', 
        (transcription) => {
          memText.value = transcription;
          memForm.dispatchEvent(new Event('submit'));
        },
        (error) => console.error('Dictation error:', error)
      );
    }

    // Memory functions
    async function loadMemories() {
      try {
        const params = new URLSearchParams();
        if (memCurrentQuery) {
          params.append('q', memCurrentQuery);
        }
        params.append('offset', memCurrentPage * memPerPage);
        params.append('limit', memPerPage);

        const memories = await window.memoriaAPI.request(`/memories?${params}`);
        renderList(memList, memories, 'memory');
        
        // Update pagination info
        memPageInfo.textContent = `Page ${memCurrentPage + 1}`;
        memPrevBtn.disabled = memCurrentPage === 0;
        memNextBtn.disabled = memories.length < memPerPage;
      } catch (error) {
        console.error('Failed to load memories:', error);
      }
    }

    function renderList(el, items, type) {
      el.innerHTML = '';
      for (const it of items) {
        const li = document.createElement('li');
        li.dataset.id = it.id;
        li.dataset.type = type;
        
        const left = document.createElement('div'); 
        left.className = 'row';
        left.style.flex = '1';
        
        const contentContainer = document.createElement('div');
        contentContainer.style.flex = '1';
        
        const title = document.createElement('div'); 
        title.textContent = (it.text || it.title);
        title.className = 'content-text';
        
        const tags = document.createElement('div'); 
        tags.className = 'tags'; 
        tags.textContent = it.tags || '';
        
        contentContainer.append(title, tags);
        
        const editIcon = document.createElement('button');
        editIcon.className = 'edit-icon';
        editIcon.innerHTML = '‚úèÔ∏è';
        editIcon.title = 'Edit';
        editIcon.onclick = () => startEdit(li, type, it);
        
        left.append(contentContainer, editIcon);
        
        const right = document.createElement('div'); 
        right.className = 'row';
        const deleteBtn = document.createElement('button'); 
        deleteBtn.className = 'pill'; 
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.onclick = async () => { 
          if (confirm('Delete this memory?')) {
            await window.memoriaAPI.request(`/memories/${it.id}`, 'DELETE');
            await loadMemories();
          }
        };
        right.append(deleteBtn);
        
        li.append(left, right);
        el.append(li);
      }
    }

    function startEdit(li, type, item) {
      // Simple edit implementation - could be enhanced
      const newText = prompt('Edit:', item.text || item.title);
      if (newText && newText !== (item.text || item.title)) {
        saveEdit(li, type, item.id, newText);
      }
    }

    async function saveEdit(li, type, id, newValue) {
      try {
        if (type === 'memory') {
          await window.memoriaAPI.request(`/memories/${id}`, 'PUT', { text: newValue });
        }
        await loadMemories();
      } catch (error) {
        console.error('Failed to save edit:', error);
      }
    }

    // Event handlers
    memForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = memText.value.trim();
      if (!text) return;
      
      try {
        await window.memoriaAPI.request('/memories', 'POST', { text });
        memText.value = '';
        await loadMemories();
      } catch (error) {
        console.error('Failed to add memory:', error);
      }
    };

    memSearchBtn.onclick = async () => {
      memCurrentQuery = memSearch.value.trim();
      memCurrentPage = 0;
      await loadMemories();
    };

    memClearBtn.onclick = async () => {
      memSearch.value = '';
      memCurrentQuery = '';
      memCurrentPage = 0;
      await loadMemories();
    };

    memPrevBtn.onclick = async () => {
      if (memCurrentPage > 0) {
        memCurrentPage--;
        await loadMemories();
      }
    };

    memNextBtn.onclick = async () => {
      memCurrentPage++;
      await loadMemories();
    };

    // Allow enter key to search
    memSearch.onkeypress = (e) => {
      if (e.key === 'Enter') {
        memSearchBtn.click();
      }
    };

    // Load initial data
    loadMemories();

    // Initialize dictation after page load
    document.addEventListener('DOMContentLoaded', initializeDictation);
  </script>
</body>
</html>